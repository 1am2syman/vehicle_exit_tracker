<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vehicle Exit Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <!-- Logo Section -->
        <div class="logo-container">
            <img src="assets/logo.png" alt="MBL Logo" class="logo">
        </div>

        <!-- Step 1: Number Plate Capture -->
        <div id="step1" class="step-section active">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Capture Number Plate</div>
            </div>
            <div class="camera-zone">
                <div class="camera-icon-wrapper" id="plateCameraIcon">
                    <svg class="camera-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                        <circle cx="12" cy="13" r="4" />
                    </svg>
                </div>
                <p class="camera-instruction">Tap to capture vehicle number plate</p>
                <input type="file" id="plateCameraInput" accept="image/*" capture="environment" class="hidden">
            </div>
            <div id="plateThumbnail" class="thumbnail-container hidden">
                <img id="plateThumbnailImg" class="thumbnail" alt="Number plate">
                <button class="retake-button" aria-label="Retake number plate">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6" />
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                    </svg>
                    Retake
                </button>
            </div>
        </div>

        <!-- Step 2: Invoice Photos Capture -->
        <div id="step2" class="step-section disabled">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Capture Invoice Photos</div>
            </div>
            <div class="camera-zone">
                <div class="camera-icon-wrapper" id="invoiceCameraIcon">
                    <svg class="camera-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                        <circle cx="12" cy="13" r="4" />
                    </svg>
                </div>
                <p class="camera-instruction">Tap to capture invoice photos</p>
                <input type="file" id="invoiceCameraInput" accept="image/*" capture="environment" multiple
                    class="hidden">
            </div>
            <div id="invoiceThumbnails" class="thumbnails-grid hidden">
                <!-- Thumbnails will be dynamically added here -->
            </div>
            <button id="addMoreInvoices" class="add-more-button hidden">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Add More Invoices
            </button>
        </div>

        <!-- Step 3: Review & Submit -->
        <div id="step3" class="step-section disabled">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Review & Submit</div>
            </div>

            <!-- OCR Initialization Status (First-time download) -->
            <div id="ocrInitStatus" class="processing-status hidden">
                <div class="processing-icon">
                    <svg class="spinner" viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" />
                    </svg>
                </div>
                <p class="processing-text">Setting up offline OCR...</p>
                <p class="processing-subtext" id="ocrInitProgress">Downloading language files (0%)</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="ocrProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <!-- On-Device OCR Processing Status -->
            <div id="localOcrStatus" class="processing-status hidden">
                <div class="processing-icon local-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />
                        <line x1="12" y1="18" x2="12.01" y2="18" />
                    </svg>
                </div>
                <p class="processing-text">Processing on device...</p>
                <p class="processing-subtext">Instant results, no server wait</p>
            </div>

            <!-- AI Fallback Processing Status -->
            <div id="aiProcessingStatus" class="processing-status hidden">
                <div class="processing-icon">
                    <svg class="spinner" viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" />
                    </svg>
                </div>
                <p class="processing-text">AI verification in progress...</p>
                <p class="processing-subtext">Low confidence detected, using cloud AI</p>
            </div>

            <!-- Extracted Data Preview -->
            <div id="extractedData" class="extracted-data hidden">
                <div class="ocr-source-badge" id="ocrSourceBadge">
                    <span class="ocr-source-icon">ü§ñ</span>
                    <span class="ocr-source-text">Processed via AI</span>
                </div>
                <div class="data-item">
                    <span class="data-label">Vehicle Number:</span>
                    <div class="data-row">
                        <span id="extractedVehicleNumber" class="data-value">--</span>
                        <input type="text" id="vehicleNumberInput" class="data-value-input hidden" aria-label="Edit vehicle number">
                        <button class="edit-icon-btn" id="editVehicleBtn" aria-label="Edit vehicle number">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <span id="vehicleConfidence" class="confidence-badge">--%</span>
                    </div>
                </div>
                <div class="data-item">
                    <span class="data-label">Invoice Numbers:</span>
                    <div id="invoiceNumbersContainer" class="invoice-numbers-container">
                        <span id="extractedInvoiceNumbers" class="data-value">--</span>
                        <input type="text" id="invoiceNumbersInput" class="data-value-input hidden" aria-label="Edit invoice numbers">
                        <button class="edit-icon-btn" id="editInvoiceBtn" aria-label="Edit invoice numbers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <span id="invoiceConfidence" class="confidence-badge">--%</span>
                    </div>
                </div>
                <div class="data-item">
                    <span class="data-label">Location:</span>
                    <span id="extractedLocation" class="data-value">Acquiring...</span>
                </div>
            </div>

            <!-- Parse Button (triggers OCR) -->
            <button id="parseBtn" class="submit-button" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);"
                disabled>
                <span class="button-text">üîç Parse Images</span>
                <span class="button-loader hidden">
                    <svg class="spinner" viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" />
                    </svg>
                </span>
            </button>

            <!-- Submit Button (only shown after successful parse) -->
            <button id="submitBtn" class="submit-button hidden" style="margin-top: 0.75rem;">
                <span class="button-text">‚úÖ Submit Entry</span>
                <span class="button-loader hidden">
                    <svg class="spinner" viewBox="0 0 50 50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="5" />
                    </svg>
                </span>
            </button>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="success-message hidden">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
            </div>
            <h2 class="success-title">Entry Submitted!</h2>
            <p class="success-text">Your vehicle exit has been recorded.</p>
            <div class="submitted-data">
                <div class="data-row">
                    <span class="data-row-label">Vehicle:</span>
                    <span id="submittedVehicleNumber" class="data-row-value">--</span>
                </div>
                <div class="data-row">
                    <span class="data-row-label">Invoices:</span>
                    <span id="submittedInvoiceNumbers" class="data-row-value">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button id="exitButton" class="exit-button secondary-button">Exit</button>
                <button id="newEntryButton" class="new-entry-button primary-button">Submit Another Exit</button>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message hidden">
            <div class="error-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
            </div>
            <h2 class="error-title">Submission Failed</h2>
            <p id="errorText" class="error-text">An error occurred. Please try again.</p>
            <button id="retryButton" class="retry-button">Retry</button>
        </div>
    </div>

    <!-- External JavaScript -->
    <script src="script.js"></script>
</body>

</html>
